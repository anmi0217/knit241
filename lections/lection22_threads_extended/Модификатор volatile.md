## **2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä volatile –≤ Java**

### **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `volatile`?**

`volatile` ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ **–∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –±—É–¥—É—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–∏–¥–Ω—ã –≤—Å–µ–º –ø–æ—Ç–æ–∫–∞–º**. –û–Ω —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É **–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö** –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ.

–í –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ –≤ **–æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (main memory)**, –Ω–æ –∏ –≤ **–∫–µ—à–∞—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤**. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ç–æ–º—É, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –ø–æ—Ç–æ–∫–æ–º, –º–æ–≥—É—Ç **–Ω–µ –±—ã—Ç—å –≤–∏–¥–Ω—ã –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–∞–º**.

‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ `volatile`**

```java
class SharedData {
    private boolean running = true; // –ë–µ–∑ volatile

    public void stop() {
        running = false; // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≤–∏–¥–Ω–æ –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ç–æ–∫–µ
    }

    public void run() {
        while (running) {
            // –í–æ–∑–º–æ–∂–µ–Ω –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª, –µ—Å–ª–∏ running –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
        }
    }
}
```

**–ü–æ—á–µ–º—É?**  
–î—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å `running` **–∏–∑ –∫—ç—à–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞**, –∞ –Ω–µ –∏–∑ –ø–∞–º—è—Ç–∏. –ü–æ—ç—Ç–æ–º—É –æ–Ω –º–æ–∂–µ—Ç **–Ω–µ —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** –∏ –∑–∞—Ü–∏–∫–ª–∏—Ç—å—Å—è.

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `volatile`

```java
private volatile boolean running = true;
```

–¢–µ–ø–µ—Ä—å –ª—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ `running` **—Å—Ä–∞–∑—É –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç—å** –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **–≤–∏–¥–∏–º—ã–º –¥–ª—è –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤**.

---

### **–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏**

–ö–æ–≥–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±—ä—è–≤–ª–µ–Ω–∞ –∫–∞–∫ `volatile`:

1. **–ß—Ç–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–º—è—Ç–∏** (–∞ –Ω–µ –∏–∑ –∫—ç—à–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞).
2. **–ó–∞–ø–∏—Å—å —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–º—è—Ç–∏**.

üìå **–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã –±–µ–∑ volatile:**

```java
class SharedResource {
    private boolean flag = false; // –ë–µ–∑ volatile

    public void setTrue() {
        flag = true;
    }

    public boolean getFlag() {
        return flag;
    }
}

public class VolatileTest {
    public static void main(String[] args) throws InterruptedException {
        SharedResource resource = new SharedResource();

        Thread writer = new Thread(() -> {
            resource.setTrue();
            System.out.println("Writer: flag set to true");
        });

        Thread reader = new Thread(() -> {
            while (!resource.getFlag()) {
                // –ú–æ–∂–µ—Ç –∑–∞—Ü–∏–∫–ª–∏—Ç—å—Å—è, –µ—Å–ª–∏ –Ω–µ —É–≤–∏–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            }
            System.out.println("Reader: flag changed!");
        });

        reader.start();
        Thread.sleep(100);
        writer.start();

        reader.join();
        writer.join();
    }
}
```

üëâ –ó–¥–µ—Å—å –ø–æ—Ç–æ–∫ `reader` –º–æ–∂–µ—Ç **–Ω–µ —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è `flag`** –∏ –∑–∞–≤–∏—Å–Ω—É—Ç—å –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ.

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ–º `volatile`**

```java
private volatile boolean flag = false;
```

–¢–µ–ø–µ—Ä—å –ø–æ—Å–ª–µ `resource.setTrue()` –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ**.

---

### **–ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Ä—è–¥–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π (Happens-Before)**

–í Java **–æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è—Ç—å—Å—è** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (Instruction Reordering). `volatile` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —ç—Ç—É –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫—É.

–ü—Ä–∏–º–µ—Ä:

```java
class ReorderingExample {
    int a = 0, b = 0, x = 0, y = 0;

    public void thread1() {
        a = 1;   // (1)
        x = b;   // (2)
    }

    public void thread2() {
        b = 1;   // (3)
        y = a;   // (4)
    }
}
```

–õ–æ–≥–∏—á–Ω–æ –æ–∂–∏–¥–∞—Ç—å, —á—Ç–æ `x == 1 || y == 1`, –Ω–æ **–±–µ–∑ volatile –≤–æ–∑–º–æ–∂–µ–Ω x == 0 –∏ y == 0** –∏–∑-–∑–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥.

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ–º `volatile` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞**

```java
private volatile int a = 0;
private volatile int b = 0;
```

–¢–µ–ø–µ—Ä—å **–ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω**.

---

### **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è `volatile`**

#### ‚ùå **1. –ù–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

`volatile` **–Ω–µ –¥–µ–ª–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –∞—Ç–æ–º–∞—Ä–Ω–æ–π**, –µ—Å–ª–∏ –æ–Ω–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∞–≥–æ–≤.

–ü—Ä–∏–º–µ—Ä —Å `i++`:

```java
class Counter {
    private volatile int count = 0;

    public void increment() {
        count++; // –ù–µ –∞—Ç–æ–º–∞—Ä–Ω–æ!
    }
}
```

–ü–æ—á–µ–º—É? `count++` —ç—Ç–æ:

1. –ß—Ç–µ–Ω–∏–µ `count`
2. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ `count`
3. –ó–∞–ø–∏—Å—å `count`

–ï—Å–ª–∏ –¥–≤–∞ –ø–æ—Ç–æ–∫–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç `count++` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –≤–æ–∑–º–æ–∂–Ω–∞ **–ø–æ—Ç–µ—Ä—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞**.

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `AtomicInteger`

```java
private AtomicInteger count = new AtomicInteger(0);

public void increment() {
    count.incrementAndGet(); // –ê—Ç–æ–º–∞—Ä–Ω–æ!
}
```

---

#### ‚ùå **2. –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**

`volatile` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç **—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π**. –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `synchronized` –∏–ª–∏ `Lock`.

–ü—Ä–æ–±–ª–µ–º–∞:

```java
class SharedData {
    private volatile int x = 0;
    private volatile int y = 0;

    public void update() {
        x = 1;
        y = 2;
    }

    public boolean check() {
        return y == 2 && x == 0; // –ú–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è!
    }
}
```

–¢–∞–∫ –∫–∞–∫ **`volatile` –Ω–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**, –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å `y = 2`, –Ω–æ `x = 0`.

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `synchronized`

```java
synchronized (this) {
    x = 1;
    y = 2;
}
```

---

### **–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `volatile`**

#### ‚úÖ **1. –§–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞**

–ß–∞—Å—Ç—ã–π —Å–ª—É—á–∞–π ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Å—Ç–∞–Ω–æ–≤ –ø–æ—Ç–æ–∫–∞**.

‚ùå –ë–µ–∑ `volatile`, –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç **–Ω–µ —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏ –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.

```java
class Worker implements Runnable {
    private volatile boolean running = true;

    public void stop() {
        running = false;
    }

    public void run() {
        while (running) {
            System.out.println("Working...");
        }
        System.out.println("Stopped.");
    }
}

public class VolatileFlagExample {
    public static void main(String[] args) throws InterruptedException {
        Worker worker = new Worker();
        Thread thread = new Thread(worker);
        thread.start();

        Thread.sleep(100);
        worker.stop(); // –ë–µ–∑ volatile –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –Ω–µ —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ running!
    }
}
```

–¢–µ–ø–µ—Ä—å `running = false;` **—Å—Ä–∞–∑—É —É–≤–∏–¥–∏—Ç** –≤—Ç–æ—Ä–æ–π –ø–æ—Ç–æ–∫, –∏ –æ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.

---

#### ‚úÖ **2. –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (Double-Checked Locking)**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è **–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–∏–Ω–≥–ª—Ç–æ–Ω–∞** –±–µ–∑ –ª–∏—à–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

‚ùå –ë–µ–∑ `volatile` –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã: –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å **—á–∞—Å—Ç–∏—á–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç**.

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ–º `volatile`**

```java
class Singleton {
    private static volatile Singleton instance;

    private Singleton() {}

    public static Singleton getInstance() {
        if (instance == null) { // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            synchronized (Singleton.class) {
                if (instance == null) { // –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
                    instance = new Singleton();
                }
            }
        }
        return instance;
    }
}
```

–ë–ª–∞–≥–æ–¥–∞—Ä—è `volatile` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è, —á—Ç–æ **–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è** –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ `instance` —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–∞–º.

---

