## **5. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å `CountDownLatch`**

### **–ß—Ç–æ —Ç–∞–∫–æ–µ `CountDownLatch`?**

`CountDownLatch` ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ –ø–∞–∫–µ—Ç–∞ `java.util.concurrent`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç **–æ–¥–Ω–æ–º—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ—Ç–æ–∫–∞–º –∂–¥–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –ø–æ—Ç–æ–∫–æ–≤**.

üîπ **–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

- –£ `CountDownLatch` –µ—Å—Ç—å **—Å—á–µ—Ç—á–∏–∫ (count)**, –∫–æ—Ç–æ—Ä—ã–π **—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è** (`countDown()`) –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–æ—Ç–æ–∫–æ–≤.
- –ü–æ—Ç–æ–∫, –≤—ã–∑–≤–∞–≤—à–∏–π `await()`, **–∂–¥–µ—Ç, –ø–æ–∫–∞ —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–Ω–µ—Ç 0**.

üìå **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `CountDownLatch`?**

- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ **–∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç—ã**.
- –ö–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è **–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞—â–µ–ª–∫–∏ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `CyclicBarrier`).

---

### **–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã: –∑–∞—â–µ–ª–∫–∞ —Å –æ–±—Ä–∞—Ç–Ω—ã–º –æ—Ç—Å—á–µ—Ç–æ–º**

1. **–°–æ–∑–¥–∞–µ—Ç—Å—è `CountDownLatch` —Å –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ—Ç–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –¥–æ–∂–¥–∞—Ç—å—Å—è).**
    
    ```java
    CountDownLatch latch = new CountDownLatch(3); // –ñ–¥–µ–º 3 –ø–æ—Ç–æ–∫–∞
    ```
    
2. **–ö–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç `countDown()`, —É–º–µ–Ω—å—à–∞—è —Å—á–µ—Ç—á–∏–∫.**
    
    ```java
    latch.countDown(); // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞ 1
    ```
    
3. **–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç `await()` –∏ –∂–¥–µ—Ç, –ø–æ–∫–∞ —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–Ω–µ—Ç 0.**
    
    ```java
    latch.await(); // –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø–æ–∫–∞ latch > 0
    ```
    
4. **–ö–∞–∫ —Ç–æ–ª—å–∫–æ `countDown()` –±—ã–ª –≤—ã–∑–≤–∞–Ω N —Ä–∞–∑, `await()` —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –∏ –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É.**

---

### **–†–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä: –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è N –∑–∞–¥–∞—á –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç—ã –≥–ª–∞–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞**

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å **–≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫**, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è **—Ç—Ä–µ—Ö —Ä–∞–±–æ—á–∏—Ö –ø–æ—Ç–æ–∫–æ–≤**, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.

#### **üîπ –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã**

1. **–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫** —Å–æ–∑–¥–∞–µ—Ç `CountDownLatch` —Å –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º 3 (`new CountDownLatch(3)`).
2. **–ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è 3 —Ä–∞–±–æ—á–∏—Ö –ø–æ—Ç–æ–∫–∞**.
3. –ö–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ **–≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É** –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `countDown()`, —É–º–µ–Ω—å—à–∞—è —Å—á–µ—Ç—á–∏–∫.
4. **–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∂–¥–µ—Ç** (`await()`), –ø–æ–∫–∞ `countDownLatch` –Ω–µ —Å—Ç–∞–Ω–µ—Ç 0.
5. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤ –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

---

### **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ —Å `CountDownLatch`**

```java
import java.util.concurrent.CountDownLatch;

public class CountDownLatchExample {
    public static void main(String[] args) throws InterruptedException {
        int numWorkers = 3;
        CountDownLatch latch = new CountDownLatch(numWorkers);

        for (int i = 1; i <= numWorkers; i++) {
            new Thread(new Worker(i, latch)).start();
        }

        System.out.println("–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—á–∏—Ö –ø–æ—Ç–æ–∫–æ–≤...");
        latch.await(); // –ñ–¥–µ–º, –ø–æ–∫–∞ —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–Ω–µ—Ç 0
        System.out.println("–í—Å–µ —Ä–∞–±–æ—á–∏–µ –ø–æ—Ç–æ–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É.");
    }
}

class Worker implements Runnable {
    private int id;
    private CountDownLatch latch;

    public Worker(int id, CountDownLatch latch) {
        this.id = id;
        this.latch = latch;
    }

    @Override
    public void run() {
        try {
            System.out.println("–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ " + id + " –Ω–∞—á–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.");
            Thread.sleep(1000 * id); // –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç—ã –ø–æ—Ç–æ–∫–∞
            System.out.println("–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ " + id + " –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.");
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            latch.countDown(); // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫
            System.out.println("–û—Å—Ç–∞–ª–æ—Å—å –ø–æ—Ç–æ–∫–æ–≤: " + latch.getCount());
        }
    }
}
```

---

### **–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–∏–º–µ—Ä)**

```
–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—á–∏—Ö –ø–æ—Ç–æ–∫–æ–≤...
–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ 1 –Ω–∞—á–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ 2 –Ω–∞—á–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ 3 –Ω–∞—á–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ 1 –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
–û—Å—Ç–∞–ª–æ—Å—å –ø–æ—Ç–æ–∫–æ–≤: 2
–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ 2 –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
–û—Å—Ç–∞–ª–æ—Å—å –ø–æ—Ç–æ–∫–æ–≤: 1
–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ 3 –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
–û—Å—Ç–∞–ª–æ—Å—å –ø–æ—Ç–æ–∫–æ–≤: 0
–í—Å–µ —Ä–∞–±–æ—á–∏–µ –ø–æ—Ç–æ–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É.
```

---

### **–†–∞–∑–±–æ—Ä –∫–æ–¥–∞**

üîπ **`CountDownLatch latch = new CountDownLatch(3);`**  
–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞—â–µ–ª–∫–∞, –æ–∂–∏–¥–∞—é—â–∞—è **3 –≤—ã–∑–æ–≤–∞ `countDown()`**.

üîπ **`latch.await();`**  
–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ **–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è** –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ `latch.getCount() == 0`.

üîπ **`latch.countDown();`**  
–ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫, –∑–∞–≤–µ—Ä—à–∏–≤ —Ä–∞–±–æ—Ç—É, —É–º–µ–Ω—å—à–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ `CountDownLatch`.

üîπ **–ö–∞–∫ —Ç–æ–ª—å–∫–æ `countDown()` –±—ã–ª –≤—ã–∑–≤–∞–Ω 3 —Ä–∞–∑–∞, `await()` —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è**, –∏ –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

---

### **–í—ã–≤–æ–¥**

‚úÖ **`CountDownLatch` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–ª–∞–≤–Ω–æ–º—É –ø–æ—Ç–æ–∫—É –∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è N –∑–∞–¥–∞—á.**  
‚úÖ **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç `synchronized`.**  
‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑ (–Ω–µ–ª—å–∑—è "—Å–±—Ä–æ—Å–∏—Ç—å" —Å—á–µ—Ç—á–∏–∫, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `CyclicBarrier`).**

üìå **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?**

- –ï—Å–ª–∏ **–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –≤—ã–ø–æ–ª–Ω—è—é—Ç –∑–∞–¥–∞—á—É, –∞ –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∂–¥–µ—Ç –∏—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**.
- –ï—Å–ª–∏ **–Ω–µ –Ω—É–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∑–∞—â–µ–ª–∫–∞).**
