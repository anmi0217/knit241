# **4. Пул потоков (Thread Pool)

**Пул потоков** — это механизм многопоточности, который управляет группой потоков, позволяя **переиспользовать** их вместо создания новых.

### **Почему стоит использовать пул потоков?**

1. **Снижение накладных расходов** – создание и уничтожение потоков – дорогая операция.
2. **Ограничение количества активных потоков** – предотвращает перегрузку системы.
3. **Лучшее управление ресурсами** – можно настроить фиксированное количество потоков.
4. **Переиспользование потоков** – когда поток завершает работу, он возвращается в пул.

---

## **ExecutorService и Executors**

В Java пулы потоков управляются через **`ExecutorService`**, а класс `Executors` предоставляет удобные фабричные методы для создания различных типов пулов.

### **Создание пула потоков**

```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class ThreadPoolExample {
    public static void main(String[] args) {
        ExecutorService executor = Executors.newFixedThreadPool(3); // 3 потока в пуле

        for (int i = 1; i <= 5; i++) {
            final int taskId = i;
            executor.submit(() -> {
                System.out.println("Задача " + taskId + " выполняется потоком " + Thread.currentThread().getName());
                try {
                    Thread.sleep(2000); // Симуляция работы потока
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("Задача " + taskId + " завершена.");
            });
        }

        executor.shutdown(); // Завершение работы пула после выполнения всех задач
    }
}
```

### **Вывод (пример)**

```
Задача 1 выполняется потоком pool-1-thread-1
Задача 2 выполняется потоком pool-1-thread-2
Задача 3 выполняется потоком pool-1-thread-3
Задача 4 выполняется потоком pool-1-thread-1
Задача 5 выполняется потоком pool-1-thread-2
```

✅ **Обратите внимание:** Всего было запущено **5 задач**, но выполняются **3 потока одновременно** (так как мы задали `newFixedThreadPool(3)`). Потоки **переиспользуются**.

---

## **Типы пулов потоков**

Класс `Executors` предоставляет несколько готовых типов пулов:

### **1. `FixedThreadPool` (Фиксированный пул потоков)**

Используется, когда **заранее известно количество потоков**. Если поток завершил задачу, он используется повторно.

```java
ExecutorService fixedPool = Executors.newFixedThreadPool(4);
```

✅ **Когда использовать?**  
Когда нужно **ограничить** количество одновременно работающих потоков, например, обработка базы данных.

---

### **2. `CachedThreadPool` (Кэшируемый пул потоков)**

- Количество потоков **динамически изменяется**.
- Если потоков не хватает – создаются **новые**.
- Если поток долго не используется – **удаляется**.

```java
ExecutorService cachedPool = Executors.newCachedThreadPool();
```

✅ **Когда использовать?**  
Когда задачи выполняются **неравномерно** и **короткие по времени**, например, обработка веб-запросов.

---

### **3. `SingleThreadExecutor` (Один поток)**

Создается **один поток**, который выполняет задачи **поочередно**.

```java
ExecutorService singlePool = Executors.newSingleThreadExecutor();
```

✅ **Когда использовать?**  
Когда задачи должны **выполняться последовательно**, например, запись логов в файл.

---

### **4. `ScheduledThreadPool` (Запланированный пул потоков)**

Позволяет **запускать задачи по расписанию**.

```java
import java.util.concurrent.*;

public class ScheduledThreadPoolExample {
    public static void main(String[] args) {
        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(2);

        scheduler.schedule(() -> System.out.println("Задача выполнена через 3 секунды"), 
                           3, TimeUnit.SECONDS);

        scheduler.shutdown();
    }
}
```

✅ **Когда использовать?**  
Когда нужно **выполнять задачи с задержкой** или **повторять через определенные интервалы** (например, автообновление данных).

---

## **Завершение пула потоков**

После отправки задач в `ExecutorService`, **необходимо корректно завершать пул**:

1. **`shutdown()`** – завершает работу пула **после выполнения всех задач**.
2. **`shutdownNow()`** – прерывает все выполняющиеся задачи.

```java
executor.shutdown(); // Ждет завершения всех задач
// executor.shutdownNow(); // Прерывает выполнение
```

---

## **Преимущества использования пулов потоков**

✅ **1. Улучшает производительность**

- Повторное использование потоков снижает накладные расходы.

✅ **2. Защищает от перегрузки системы**

- Контролируемое количество потоков предотвращает чрезмерную загрузку процессора.

✅ **3. Простота управления потоками**

- `ExecutorService` автоматически управляет задачами.

✅ **4. Гибкость**

- Можно выбрать `FixedThreadPool`, `CachedThreadPool` или `ScheduledThreadPool` в зависимости от задачи.

---

## **Вывод**

- `ThreadPool` используется для **эффективного управления потоками**.
- **`ExecutorService`** предоставляет удобный интерфейс для работы с пулами потоков.
- `FixedThreadPool` – фиксированное количество потоков.
- `CachedThreadPool` – динамически изменяемое количество потоков.
- `SingleThreadExecutor` – один поток для последовательных задач.
- `ScheduledThreadPool` – выполнение задач по расписанию.
- **Пулы потоков** уменьшают затраты на создание новых потоков и предотвращают перегрузку системы.